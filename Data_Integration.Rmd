---
title: "Integration"
output: html_document
date: "2024-03-20"
---

# Set Up

## Installing scvi-tools

```{r eval = FALSE}
library(reticulate)
conda_create("scvi-env")
conda_install("sci-env", "scvi-tools", pip = TRUE)
conda_install("sci-env", "scanpy", pip = TRUE)
```

## Loading Libraries and Functions

```{r}
library(Seurat)
library(SeuratWrappers)

source("./R/checkAndUpdateGenes.R")
```

## Finding Initial Features Space for Full Integration

Here I am randomly sampling 20% of the Seurat Objects in order to get the 4000 most variable features. This sampling is across tissues and tumors to make it robust. We will use the features to subset the Seurat Objects towards a full integration.

```{r}

files <- list.files("./data/processedData/seuratObjects/")
names <- stringr::str_remove_all(files, ".rds")

set.seed(42)
sampled <- sample(727, 146)
files <- files[sampled]
names <- names[sampled]
gene.symbols <- HGNChelper::hgnc.table
object.list <- lapply(files, function(x) {
                      obj <- readRDS(paste0("./data/processedData/seuratObjects/", x))
                      
                      LayerData(obj, layer = "data") <- NULL
                      obj@meta.data <- obj[[]][,1:6]
                      obj$orig.ident <- names[x]
                      obj
})
gc()

object.merge <- merge(object.list[[1]], object.list[-1])
rm(object.list)
gc()

object.merge  <- NormalizeData(object.merge )
object.merge <- JoinLayers(object.merge)
object.merge  <- FindVariableFeatures(object.merge, nfeatures = 6000)

# Removing specific feature sets
features.to.use <- VariableFeatures(object.merge)
features.to.use <- Ibex::quietBCRgenes(features.to.use)
features.to.use <- Trex::quietTCRgenes(features.to.use)
features.to.use <- features.to.use[!grepl("RPS|RPL|LINC|MT-|AC0|AC1|AC2|RP11-|MIR|HB|IGHV", features.to.use)]

# Checking for gene nomenclature issues and removing feature that might be confounding
updated.features <- checkAndUpdateGenes(features.to.use, gene.symbols = gene.symbols)
new.features <- updated.features[[1]]
new.features[which(is.na(new.features))] <- features.to.use[which(is.na(new.features))]
new.features <- new.features[-which(new.features != features.to.use)]

#Taking the top 4000 features for integration
new.features <- new.features[1:4000]

saveRDS(new.features, "./outputs/reference/Overall_featureSpace.rds")
rm(object.merge)
gc()
```

# Integrating All Cells

Now we can take all the Seurat Objects and subset them by the most variable features across presumably the cohort (sampled cohort above).

```{r}
files <- list.files("./data/processedData/seuratObjects/")
names <- stringr::str_remove_all(files, ".rds")
features.to.use <- readRDS("./outputs/reference/Overall_featureSpace.rds")

object.list <- lapply(files, function(x) {
                      obj <- readRDS(paste0("./data/processedData/seuratObjects/", x))
                      obj <- subset(obj, features = features.to.use)
                      obj$orig.ident <- names[x]
                      obj
})
gc()

object.merge <- merge(object.list[[1]], object.list[-1])
rm(object.list)
gc()

object.merge  <- NormalizeData(object.merge )
object.merge  <- FindVariableFeatures(object.merge )
object.merge  <- ScaleData(object.merge)
object.merge  <- RunPCA(object.merge, verbose = FALSE)



object.merge <- IntegrateLayers(object.merge,
                                assay = "RNA",
                                method = FastMNNIntegration,
                                new.reduction = "integrated.mnn",
                                verbose = FALSE)

object.merge <- RunUMAP(object.merge, 
                        reduction = "integrated.mnn", 
                        dims = 1:30, 
                        reduction.name = "umap.mnn") 


object.merge$tissue <- stringr::str_split(object.merge$orig.ident, "[.]", simplify = TRUE)[,2]

saveRDS(object.merge, "./data/integratedSeuratObject.rds")

DimPlot(
  object.merge,
  reduction = "umap.mnn",
  group.by = c("orig.ident", "predicted.celltype.l2", "tissue", "cloneSize"),
  combine = FALSE, 
  label.size = 2
)

FeaturePlot(object.merge, c("CD4", "CD8A", "FOXP3"))


```

 ####################
                      #Filtering Strategy
                      ###################
                      #Step 1: Only taking T/NK cells from Automated Annotation
                      if("predicted.celltype.l1" %in% colnames(obj[[]])) {
                        obj <- subset(obj, predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T", "NK"))
                      } 
                      
                      #Step 2: Only cells with contig data
                      if("CTaa" %in% colnames(obj[[]])) {
                        cells <- which(!is.na(obj[[]][,"CTaa"]))
                        obj <- subset(obj, cells = colnames(obj)[cells])
                      }
                      
                      #Step 3: Only cells estimated to be singlets
                      if("db.class" %in% colnames(obj[[]])) {
                        obj <- subset(obj, db.class == "singlet")
                      }
