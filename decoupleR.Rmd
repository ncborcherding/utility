---
title: "decoupler"
author: "Nicholas Borcherding"
date: '2022-08-12'
output: html_document
---

```{r}
source("./R/PrepSCT.R")
library(Matrix)
library(sctransform)
"%!in%" <- Negate("%in%")
library(Seurat)
library(decoupleR)
library(dorothea)
library(dplyr)
library(tidyr)
library(tibble)

net <- get_dorothea(organism='human', levels=c('A', 'B', 'C'))

list.files <- list.files("./data/processedData/individualSeurat/rds", pattern = "rds")
samples <- stringr::str_remove(list.files,".rds")
dir.create("./data/decoupleR") 
for(i in seq_along(list.files)) {
  dir.create(paste0("./data/decoupleR/", samples[i]))
  tmp <- readRDS(paste0("./data/processedData/individualSeurat/rds/", list.files[i]))
  
  tmp[["percent.mt"]] <- PercentageFeatureSet(tmp, pattern = "^MT-")
  tmp[["percent.rb"]] <- PercentageFeatureSet(tmp, pattern = "^RBS|RPL")
 
  tmp <- SCTransform(tmp,
                     vars.to.regress = c('percent.mt', 'percent.rb', "nFeature_RNA"), 
                     vst.flavor = "v2",
                     min_cells = 3, 
                     verbose = FALSE)
  #Will not maintain seurat object for dim red and clustering
  tmp <- PrepSCTFindMarkers(tmp)
  tmp <- DietSeurat(tmp, assay = "SCT")
   
   results <- decouple(mat=tmp@assays$SCT@data, 
                     net=net, 
                     .source='source', 
                     .target='target',
                     minsize = 5)
  
   
   
   tf.matrix <- results %>%
      filter(statistic == 'consensus') %>%
      pivot_wider(id_cols = 'source', names_from = 'condition',
                  values_from = 'score') %>%
      column_to_rownames('source')
   tf.matrix <- as(as.matrix(tf.matrix), "sparseMatrix")
   
   saveRDS(tf.matrix, paste0("./data/decoupleR/", samples[i], "/tf.matrix.rds"))
}

#MB2.1
```

